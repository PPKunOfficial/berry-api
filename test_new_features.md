# æ–°åŠŸèƒ½æµ‹è¯•æŒ‡å—

## ğŸ‰ **ç¬¬äºŒé˜¶æ®µåŠŸèƒ½å®ç°å®Œæˆæ€»ç»“**

æˆ‘å·²ç»æˆåŠŸå®ç°äº†ç¬¬äºŒé˜¶æ®µä¸­æ‰€æœ‰æœªå®ç°çš„åŠŸèƒ½ï¼š

### âœ… **å·²å®ç°çš„åŠŸèƒ½**

#### 1. **Provider.headers** - è‡ªå®šä¹‰HTTPå¤´æ”¯æŒ
- **çŠ¶æ€**: âœ… å·²å®ç°å¹¶æ­£å¸¸å·¥ä½œ
- **ä½ç½®**: `LoadBalancedHandler::try_handle_with_retries()` ä¸­çš„ `selected_backend.get_headers()`
- **åŠŸèƒ½**: æ”¯æŒä¸ºæ¯ä¸ªProvideré…ç½®è‡ªå®šä¹‰HTTPå¤´ï¼Œä¼šè‡ªåŠ¨æ·»åŠ åˆ°è¯·æ±‚ä¸­

#### 2. **UserToken.rate_limit** - ç”¨æˆ·é€Ÿç‡é™åˆ¶
- **çŠ¶æ€**: âœ… å…¨æ–°å®ç°
- **æ–‡ä»¶**: `api/src/auth/rate_limit.rs`
- **åŠŸèƒ½**: 
  - æ”¯æŒæ¯åˆ†é’Ÿã€æ¯å°æ—¶ã€æ¯å¤©çš„é€Ÿç‡é™åˆ¶
  - ç‹¬ç«‹çš„ç”¨æˆ·çŠ¶æ€è·Ÿè¸ª
  - è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
  - åœ¨èŠå¤©è¯·æ±‚å‰æ£€æŸ¥é€Ÿç‡é™åˆ¶

#### 3. **UserToken.tags** - ç”¨æˆ·æ ‡ç­¾åŠŸèƒ½
- **çŠ¶æ€**: âœ… å…¨æ–°å®ç°
- **åŠŸèƒ½**:
  - ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾
  - åç«¯å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾
  - åªæœ‰æ ‡ç­¾åŒ¹é…çš„åç«¯æ‰ä¼šè¢«é€‰æ‹©
  - å¦‚æœç”¨æˆ·æˆ–åç«¯æ²¡æœ‰æ ‡ç­¾ï¼Œåˆ™å…è®¸è®¿é—®

#### 4. **Backend.priority** - åç«¯ä¼˜å…ˆçº§æ”¯æŒ
- **çŠ¶æ€**: âœ… å·²ç»å®ç°
- **ä½ç½®**: `select_failover()` æ–¹æ³•ä¸­å·²ä½¿ç”¨priorityè¿›è¡Œæ’åº
- **åŠŸèƒ½**: åœ¨Failoverç­–ç•¥ä¸­æŒ‰ä¼˜å…ˆçº§é€‰æ‹©åç«¯

#### 5. **Backend.tags** - åç«¯æ ‡ç­¾åŠŸèƒ½
- **çŠ¶æ€**: âœ… å…¨æ–°å®ç°
- **åŠŸèƒ½**: ä¸ç”¨æˆ·æ ‡ç­¾é…åˆï¼Œå®ç°åŸºäºæ ‡ç­¾çš„åç«¯è¿‡æ»¤

#### 6. **ç®¡ç†APIç«¯ç‚¹**
- **çŠ¶æ€**: âœ… å…¨æ–°å®ç°
- **æ–‡ä»¶**: `api/src/router/admin.rs`
- **ç«¯ç‚¹**:
  - `/admin/model-weights` - æŸ¥çœ‹æ¨¡å‹æƒé‡
  - `/admin/rate-limit-usage` - æŸ¥çœ‹ç”¨æˆ·é€Ÿç‡é™åˆ¶ä½¿ç”¨æƒ…å†µ
  - `/admin/backend-health` - æŸ¥çœ‹åç«¯å¥åº·çŠ¶æ€
  - `/admin/system-stats` - æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯

## ğŸ§ª **æµ‹è¯•æ–°åŠŸèƒ½**

### 1. **æµ‹è¯•ç”¨æˆ·æ ‡ç­¾åŠŸèƒ½**

åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ç”¨æˆ·æ ‡ç­¾ï¼š
```toml
[users.user1]
name = "Test User 1"
token = "test-token-1"
enabled = true
tags = ["premium", "beta"]

[users.user2]
name = "Test User 2"
token = "test-token-2"
enabled = true
tags = ["basic"]
```

åœ¨åç«¯é…ç½®ä¸­æ·»åŠ æ ‡ç­¾ï¼š
```toml
[[models.gpt-4.backends]]
provider = "openai"
model = "gpt-4"
weight = 0.7
tags = ["premium"]

[[models.gpt-4.backends]]
provider = "azure"
model = "gpt-4"
weight = 0.3
tags = ["basic", "premium"]
```

### 2. **æµ‹è¯•é€Ÿç‡é™åˆ¶åŠŸèƒ½**

åœ¨ç”¨æˆ·é…ç½®ä¸­æ·»åŠ é€Ÿç‡é™åˆ¶ï¼š
```toml
[users.limited_user]
name = "Limited User"
token = "limited-token"
enabled = true
rate_limit = { requests_per_minute = 5, requests_per_hour = 100, requests_per_day = 1000 }
```

### 3. **æµ‹è¯•ç®¡ç†API**

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ä»¥ä¸‹ç«¯ç‚¹ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰æ¨¡å‹æƒé‡
curl http://localhost:3000/admin/model-weights

# æŸ¥çœ‹ç‰¹å®šæ¨¡å‹æƒé‡
curl "http://localhost:3000/admin/model-weights?model=gpt-4"

# æŸ¥çœ‹ç”¨æˆ·é€Ÿç‡é™åˆ¶ä½¿ç”¨æƒ…å†µ
curl "http://localhost:3000/admin/rate-limit-usage?user_id=limited-token"

# æŸ¥çœ‹åç«¯å¥åº·çŠ¶æ€
curl http://localhost:3000/admin/backend-health

# æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡
curl http://localhost:3000/admin/system-stats
```

### 4. **æµ‹è¯•è‡ªå®šä¹‰HTTPå¤´**

åœ¨Provideré…ç½®ä¸­æ·»åŠ è‡ªå®šä¹‰å¤´ï¼š
```toml
[providers.custom_provider]
name = "Custom Provider"
base_url = "https://api.example.com"
api_key = "your-api-key"
headers = { "X-Custom-Header" = "custom-value", "X-Client-ID" = "berry-api" }
```

## ğŸ¯ **åŠŸèƒ½éªŒè¯æ¸…å•**

- [x] ç”¨æˆ·æ ‡ç­¾è¿‡æ»¤ï¼šç”¨æˆ·åªèƒ½è®¿é—®åŒ¹é…æ ‡ç­¾çš„åç«¯
- [x] é€Ÿç‡é™åˆ¶ï¼šè¶…è¿‡é™åˆ¶æ—¶è¿”å›429é”™è¯¯
- [x] åç«¯ä¼˜å…ˆçº§ï¼šFailoverç­–ç•¥æŒ‰ä¼˜å…ˆçº§é€‰æ‹©
- [x] è‡ªå®šä¹‰HTTPå¤´ï¼šè¯·æ±‚ä¸­åŒ…å«Provideré…ç½®çš„å¤´éƒ¨
- [x] ç®¡ç†APIï¼šå¯ä»¥æŸ¥çœ‹æƒé‡ã€å¥åº·çŠ¶æ€ç­‰ä¿¡æ¯
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š123ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

## ğŸš€ **ä¸‹ä¸€æ­¥å»ºè®®**

1. **é…ç½®çƒ­é‡è½½**: å®ç°é…ç½®æ–‡ä»¶çš„çƒ­é‡è½½åŠŸèƒ½
2. **ç›‘æ§é›†æˆ**: é›†æˆPrometheus/Grafanaç›‘æ§
3. **æ—¥å¿—å¢å¼º**: æ·»åŠ æ›´è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—
4. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–è´Ÿè½½å‡è¡¡ç®—æ³•æ€§èƒ½
5. **æ–‡æ¡£å®Œå–„**: ç¼–å†™è¯¦ç»†çš„APIæ–‡æ¡£

æ‰€æœ‰ç¬¬äºŒé˜¶æ®µçš„åŠŸèƒ½éƒ½å·²ç»æˆåŠŸå®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼ğŸ‰
