# ⚖️ 负载均衡策略

Berry API 使用智能AI负载均衡策略，专为小流量、成本敏感的场景设计。

## 🧠 SmartAI策略详解

SmartAI是Berry API的核心创新，专为小流量、成本敏感的场景设计，旨在通过智能学习和自适应调整，优化后端选择，提高系统稳定性和成本效益。

**核心特性：**

*   **成本感知选择**：优先选择成本效益高的后端，同时将高性能/高成本的premium后端作为备选。
*   **智能健康检查**：结合主动（轻量级连通性检查）和被动（基于用户请求反馈）两种方式，实时评估后端健康状况。
*   **信心度机制**：为每个后端动态维护一个信心度评分，综合反映其历史表现和当前状态。
*   **自适应权重调整**：根据信心度动态调整后端选择权重，确保流量流向更可靠、性能更好的后端。
*   **渐进式恢复**：对于从故障中恢复的后端，采用逐步增加权重的方式，避免流量冲击。
*   **无需额外配置**：开箱即用的智能负载均衡，减少运维负担。

### 工作原理

SmartAI策略的核心在于其动态的后端健康评估和智能选择机制。

#### 1. 信心度计算 (Confidence Score)

每个后端都维护一个0.0到1.0之间的信心度评分，初始值为0.8。信心度根据后端处理请求的成功与失败动态调整：

*   **成功请求**：每次成功响应，信心度提升0.1，最高可达1.0。
*   **失败请求**：根据错误类型施加不同的惩罚，降低信心度，最低可降至0.05。
    *   **网络错误 (NetworkError)**：连接超时、DNS失败等，惩罚0.3。
    *   **认证错误 (AuthError)**：401、403、API密钥无效等，惩罚0.8（最高惩罚，因为通常表示配置严重问题）。
    *   **限流错误 (RateLimitError)**：429 Too Many Requests，惩罚0.1（最低惩罚，通常是暂时性问题）。
    *   **服务器错误 (ServerError)**：5xx错误，惩罚0.2。
    *   **模型错误 (ModelError)**：模型不存在、参数错误等，惩罚0.3。
    *   **超时错误 (TimeoutError)**：请求处理超时，惩罚0.2。
*   **时间衰减 (Time Decay)**：如果后端长时间没有请求（即`last_request_time`距离当前时间较远），其信心度会随时间衰减，但不会低于0.5，以保留其基本可用性。衰减因子根据时间间隔递减：
    *   1小时内：无衰减 (1.0)
    *   2-6小时：轻微衰减 (0.95)
    *   7-24小时：中等衰减 (0.9)
    *   1-3天：较大衰减 (0.8)
    *   3天以上：大幅衰减 (0.7)
*   **连通性检查 (Connectivity Check)**：独立的轻量级健康检查器会定期检查所有Provider的基础URL和Models API连通性。如果连通性检查失败，后端信心度会直接降低50%，最低可降至0.05。

#### 2. 后端选择与权重调整

SmartAI不再使用固定的80/20探索策略，而是通过动态计算的“有效权重”进行加权随机选择，确保所有健康后端都有被选中的机会，同时优先选择表现更好的后端。

*   **有效权重计算**：每个后端的最终选择权重由其`base_weight`（配置中定义）、`confidence_weight`（基于信心度）和`stability_bonus`（稳定性加成）共同决定：
    `Effective Weight = Base Weight × Confidence Weight × Stability Bonus`
    *   **信心度权重 (`confidence_weight`)**：为了避免信心度对权重产生极端影响，使用平方根函数对信心度进行平滑处理。例如，信心度为0.05时，`confidence_weight`为0.1；信心度为1.0时，`confidence_weight`为1.0。这确保了即使信心度较低的后端也能保留一定的选择机会，同时高信心度后端获得显著优势。
    *   **稳定性加成 (`stability_bonus`)**：对于非`premium`后端，如果其信心度极高（>0.95），会获得额外的5%权重加成，以奖励其持续的稳定表现。`premium`后端不享受此加成，凭原始权重竞争。
    *   **不健康后端权重**：如果后端被标记为不健康（`unhealthy_info`存在），其有效权重会降至原始权重的10%，以限制流量并进行隔离。

*   **加权随机选择**：系统根据所有可用后端的有效权重进行加权随机选择。有效权重越高的后端，被选中的概率越大。这种方式比固定比例探索更灵活，能更好地适应后端状态的动态变化。

#### 3. 渐进式恢复机制 (Progressive Recovery)

当一个后端从不健康状态恢复时，SmartAI会采用渐进式恢复机制，逐步增加其权重，而不是立即恢复到全量权重，以避免流量冲击和潜在的二次故障。

*   **初始隔离**：当后端首次被标记为不健康时，其有效权重会立即降至原始权重的10%。
*   **被动验证**：系统会以低权重（10%）继续向该后端发送少量请求进行被动验证。
*   **阶段性恢复**：如果这些验证请求成功，后端将根据连续成功次数逐步提升权重：
    *   **第一阶段 (RecoveryStage1)**：1-2次成功后，权重提升至原始权重的30%。
    *   **第二阶段 (RecoveryStage2)**：3-4次成功后，权重提升至原始权重的50%。
    *   **完全恢复 (FullyRecovered)**：5次及以上成功后，权重恢复到原始权重的100%，并从不健康列表中移除。

这种机制确保了后端在完全恢复健康并稳定运行后，才能重新承担全部流量，从而提高了系统的整体韧性。

### 配置示例

```toml
[models.smart_model]
name = "smart-model"
strategy = "smart_ai"  # 使用SmartAI策略
enabled = true

[[models.smart_model.backends]]
provider = "cheap-provider"
model = "gpt-3.5-turbo"
weight = 0.6    # 60%权重 - 成本优先
priority = 1
enabled = true
tags = []       # 普通后端

[[models.smart_model.backends]]
provider = "premium-provider"
model = "gpt-4"
weight = 0.4    # 40%权重 - 质量保证
priority = 2
enabled = true
tags = ["premium"]  # 标记为premium后端

[[models.smart_model.backends]]
provider = "backup-provider"
model = "gpt-3.5-turbo"
weight = 0.2    # 20%权重 - 备用服务
priority = 3
enabled = true
tags = []
```

### SmartAI的优势：

*   ✅ **成本控制**：通过信心度机制和权重调整，优先使用表现良好且成本效益高的后端。
*   ✅ **智能故障转移**：结合主动和被动健康检查，自动检测、隔离和恢复不健康的后端。
*   ✅ **小流量优化**：通过加权随机选择和渐进式恢复，即使在流量较小的情况下也能有效探索后端并快速适应变化。
*   ✅ **自适应学习**：根据历史请求结果和错误类型动态调整后端信心度，实现自我优化。
*   ✅ **高韧性**：渐进式恢复机制避免了后端恢复时的流量冲击，提高了系统的稳定性。
*   ✅ **无需额外配置**：开箱即用的智能负载均衡，降低了用户的配置和运维复杂性。
