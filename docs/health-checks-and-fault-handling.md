# 🏥 健康检查与故障处理

### 健康检查配置

```toml
[settings]
health_check_interval_seconds = 30    # 检查间隔（秒）
circuit_breaker_failure_threshold = 5 # 熔断阈值
circuit_breaker_timeout_seconds = 60  # 熔断恢复时间（秒）
```

### 健康检查机制

1.  **定期检查**: 每30秒自动检查所有Provider的健康状态
2.  **模型列表验证**: 通过调用 `/v1/models` 端点验证服务可用性
3.  **聊天请求测试**: 发送简单的聊天请求验证模型功能
4.  **自动标记**: 根据检查结果自动标记Provider为健康/不健康

### 故障转移流程

当某个Provider出现故障时：

1.  **故障检测**
    -   API请求失败
    -   健康检查失败
    -   响应超时

2.  **自动处理**
    -   立即标记为不健康
    -   将流量切换到其他健康的Provider
    -   记录故障指标

3.  **恢复检测**
    -   定期重试故障的Provider
    -   健康检查通过后自动恢复
    -   用户请求成功也会触发恢复

4.  **流量恢复**
    -   恢复后自动重新加入负载均衡
    -   按配置的权重分配流量

### 熔断机制

```
正常状态 ──失败次数达到阈值──▶ 熔断状态
    ▲                           │
    │                           │
    └──超时后自动尝试恢复────────┘
```

-   **触发条件**: 连续失败次数达到 `circuit_breaker_failure_threshold`
-   **熔断期间**: 不会向该Provider发送请求
-   **自动恢复**: 超过 `circuit_breaker_timeout_seconds` 后自动尝试恢复

### 故障处理最佳实践

1.  **多Provider配置**: 为每个模型配置多个Provider
2.  **合理的权重分配**: 主Provider权重高，备用Provider权重低
3.  **适当的超时设置**: 避免过长的等待时间
4.  **监控告警**: 定期检查健康状态和指标

### 🏥 健康检查机制 (来自README)

Berry API 实现了差异化的健康检查策略：

**按计费模式分类：**

-   **按Token计费**：执行主动健康检查（调用模型API）
-   **按请求计费**：使用被动验证（基于用户请求结果）

**检查流程：**

```
定期检查 → 模型列表API → 简单聊天测试 → 更新健康状态
     ↓
用户请求 → 成功/失败 → 自动恢复/标记故障
     ↓
渐进恢复 → 30% → 50% → 100% 权重恢复
```
