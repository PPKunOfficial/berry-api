# 🏛️ 架构设计

Berry API 采用模块化架构设计，由5个核心模块组成：

```
┌─────────────────────────────────────────────────────────────────┐
│                        Berry API Gateway                        │
├─────────────────┬─────────────────┬─────────────────┬───────────┤
│   berry-api     │  berry-relay    │ berry-loadbalance│berry-core │
│   Web服务层     │   请求转发层    │   负载均衡层     │  核心库   │
│                 │                 │                 │           │
│ • HTTP路由      │ • 请求转发      │ • 后端选择      │ • 配置管理│
│ • 认证中间件    │ • 流式处理      │ • 健康检查      │ • 认证系统│
│ • 静态文件      │ • 错误处理      │ • 指标收集      │ • 共享类型│
│ • 管理接口      │ • 协议适配      │ • 策略实现      │ • 工具函数│
└─────────────────┴─────────────────┴─────────────────┴───────────┘
                                │
                    ┌───────────┴───────────┐
                    │      berry-cli        │
                    │     命令行工具        │
                    │                       │
                    │ • 配置验证            │
                    │ • 健康检查            │
                    │ • 指标查看            │
                    │ • 后端测试            │
                    └───────────────────────┘
```

### 🔄 请求处理流程

```mermaid
graph TD
    A[客户端请求] --> B[认证中间件]
    B --> C{认证成功?}
    C -->|否| D[返回401错误]
    C -->|是| E[权限检查]
    E --> F{有权限?}
    F -->|否| G[返回403错误]
    F -->|是| H[速率限制检查]
    H --> I{未超限?}
    I -->|否| J[返回429错误]
    I -->|是| K[负载均衡选择]
    K --> L[后端健康检查]
    L --> M{后端健康?}
    M -->|否| N[重试其他后端]
    M -->|是| O[转发请求]
    O --> P[处理响应]
    P --> Q{流式响应?}
    Q -->|是| R[SSE流式传输]
    Q -->|否| S[JSON响应]
    R --> T[返回客户端]
    S --> T
    N --> K
```

### 🧩 核心组件

| 组件 | 功能 | 技术栈 |
|------|------|--------|
| **berry-api** | Web服务层，提供HTTP API | Axum, Tower |
| **berry-relay** | 请求转发层，处理上游请求 | Reqwest, Tokio |
| **berry-loadbalance** | 负载均衡层，实现选择策略 | 自研算法, Metrics |
| **berry-core** | 核心库，配置和认证管理 | Serde, TOML |
| **berry-cli** | 命令行工具，运维管理 | Clap, 配置验证 |
